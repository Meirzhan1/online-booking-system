<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>My bookings</title>
  <link rel="stylesheet" href="./styles.css"/>
  <style>
    .bookings-page .card{
      border-radius: 24px;
      border: 1px solid rgba(0,0,0,.08);
      box-shadow: 0 20px 40px rgba(0,0,0,.05);
      background: linear-gradient(180deg,#ffffff 0%, #fbfaf7 100%);
    }
    .bookings-head{display:flex;align-items:end;justify-content:space-between;gap:10px}
    .bookings-hint{color:#7b7b7b;font-size:13px}
    #list{display:grid;gap:14px;margin-top:18px}
    .booking-card{
      border: 1px solid rgba(0,0,0,.08);
      border-radius: 16px;
      padding: 16px;
      background: #fff;
      box-shadow: 0 8px 20px rgba(0,0,0,.04);
    }
    .booking-top{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
    .booking-title{margin:0;font-size:30px;line-height:1.2}
    .booking-sub{margin-top:6px;color:#727272;font-size:14px}
    .status-pill{
      display:inline-flex;align-items:center;padding:6px 10px;border-radius:999px;
      font-size:12px;font-weight:700;letter-spacing:.04em;text-transform:uppercase;border:1px solid transparent
    }
    .status-pill.pending{background:#fff4db;color:#8f5f00;border-color:#f1d395}
    .status-pill.confirmed{background:#e9f8ee;color:#156a37;border-color:#b7e3c5}
    .status-pill.canceled{background:#f7ecec;color:#8b2f2f;border-color:#e3bdbd}
    .booking-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:10px;margin-top:14px}
    .info-card{padding:10px 12px;border-radius:12px;background:#f7f5ef;border:1px solid rgba(0,0,0,.05)}
    .info-label{font-size:12px;color:#7b7b7b;text-transform:uppercase;letter-spacing:.05em}
    .info-value{margin-top:3px;font-weight:600}
    .booking-actions{display:flex;gap:8px;margin-top:14px;flex-wrap:wrap}
    .booking-btn{
      border:1px solid #d6d6d2;background:#fff;color:#222;padding:9px 13px;border-radius:10px;cursor:pointer;
      font-weight:600;transition:.15s ease;
    }
    .booking-btn:hover{transform:translateY(-1px);box-shadow:0 5px 10px rgba(0,0,0,.08)}
    .booking-btn.primary{background:#1f3b36;color:#fff;border-color:#1f3b36}
    .booking-btn.danger{background:#fff;color:#8b2f2f;border-color:#d7b0b0}
    .booking-form{display:none;margin-top:12px;gap:8px;align-items:center;flex-wrap:wrap}
    .booking-form input{
      background:#fff;color:#111;border:1px solid #ccc;padding:9px;border-radius:10px;min-width:165px
    }
    .muted-note{margin-top:12px;color:#767676;font-size:13px}
    @media (max-width: 900px){
      .bookings-head{
        align-items:flex-start;
        flex-direction:column;
      }
      .bookings-hint{
        font-size:12px;
      }
      .booking-title{
        font-size:26px;
      }
    }
    @media (max-width: 620px){
      .bookings-page .card{
        border-radius:16px;
        padding:12px;
      }
      .booking-title{
        font-size:24px;
      }
      #list{
        gap:10px;
        margin-top:12px;
      }
      .booking-card{
        padding:12px;
        border-radius:12px;
      }
      .booking-top{
        flex-direction:column;
        align-items:flex-start;
        gap:8px;
      }
      .booking-top h3{
        margin:0;
        font-size:18px;
        line-height:1.25;
      }
      .booking-sub{
        font-size:12px;
      }
      .status-pill{
        font-size:11px;
        padding:5px 8px;
      }
      .booking-grid{
        grid-template-columns:1fr;
        gap:8px;
      }
      .info-card{
        padding:9px 10px;
      }
      .info-label{
        font-size:11px;
      }
      .info-value{
        font-size:14px;
      }
      .booking-actions{
        margin-top:10px;
        gap:8px;
        flex-direction:column;
      }
      .booking-btn{
        width:100%;
      }
      .booking-form{
        gap:8px;
      }
      .booking-form input{
        min-width:0;
        width:100%;
      }
      .muted-note{
        font-size:12px;
      }
    }
  </style>
</head>
<body>

<header class="navbar">
  <div class="navbar-inner">
    <div class="nav-left">
      <a class="nav-link" href="./index.html">Home</a>
      <a class="nav-link" href="./hotels.html">Hotels</a>
    </div>
    <div class="brand">
      <img class="brand-logo" src="./images/delux_l.png" alt="Delux Hotels">
    </div>
    <div class="nav-right">
      <a class="nav-link nav-user" href="./profile.html" style="display:none;">Profile</a>
      <a class="nav-link nav-user" href="./my-bookings.html" style="display:none;">My bookings</a>
      <a class="nav-link nav-admin" href="./admin-hotels.html" style="display:none;">Admin hotels</a>
      <a class="nav-link nav-admin" href="./admin-rooms.html" style="display:none;">Admin rooms</a>
      <button class="icon-btn nav-logout" style="display:none;" title="Logout">Logout</button>
    </div>
  </div>
</header>

<main class="container bookings-page">
  <div class="card">
    <div class="bookings-head">
      <h1 class="h booking-title">My bookings</h1>
      <div class="bookings-hint">Manage upcoming stays and reservations</div>
    </div>
    <div id="error"></div>
    <div id="list"></div>
  </div>
</main>

<script src="./api.js"></script>
<script src="./nav-auth.js"></script>
<script>
(async function init() {
  const token = sessionStorage.getItem("token");
  if (!token) {
    location.href = "./index.html";
    return;
  }

  try {
    const data = await api("/api/bookings/my");
    const el = document.getElementById("list");

    if (!Array.isArray(data) || data.length === 0) {
      el.innerHTML = "<p class='muted-note'>No bookings yet. Book your first room from the Hotels page.</p>";
      return;
    }

    el.innerHTML = data.map((b) => {
      const room = b.roomId || {};
      const hotel = room.hotelId || {};
      const inD = b.checkIn ? new Date(b.checkIn).toLocaleDateString("en-US", { weekday: "short", month: "short", day: "2-digit", year: "numeric" }) : "-";
      const outD = b.checkOut ? new Date(b.checkOut).toLocaleDateString("en-US", { weekday: "short", month: "short", day: "2-digit", year: "numeric" }) : "-";
      const inISO = b.checkIn ? new Date(b.checkIn).toISOString().slice(0, 10) : "";
      const outISO = b.checkOut ? new Date(b.checkOut).toISOString().slice(0, 10) : "";
      const status = (b.status || "UNKNOWN").toUpperCase();
      const statusClass = status.toLowerCase();
      const editable = status === "PENDING";

      return `
        <div class="booking-card" data-booking-id="${b._id}">
          <div class="booking-top">
            <div>
              <h3>${hotel.name || "Hotel"} (${hotel.city || "-"})</h3>
              <div class="booking-sub">Reservation #${b._id ? String(b._id).slice(-6).toUpperCase() : "-"}</div>
            </div>
            <div class="status-pill ${statusClass}">${status}</div>
          </div>

          <div class="booking-grid">
            <div class="info-card">
              <div class="info-label">Room</div>
              <div class="info-value">${room.roomNumber || "-"} (${room.type || "-"})</div>
            </div>
            <div class="info-card">
              <div class="info-label">Dates</div>
              <div class="info-value">${inD} &rarr; ${outD}</div>
            </div>
            <div class="info-card">
              <div class="info-label">Total</div>
              <div class="info-value">${(b.totalPrice ?? 0).toLocaleString("en-US")} KZT</div>
            </div>
          </div>

          ${editable ? `
            <div class="booking-actions">
              <button class="booking-btn js-edit" type="button" data-id="${b._id}">Edit dates</button>
              <button class="booking-btn danger js-cancel" type="button" data-id="${b._id}">Cancel booking</button>
            </div>
            <form class="booking-form js-edit-form" data-id="${b._id}">
              <input type="date" name="checkIn" value="${inISO}" required />
              <input type="date" name="checkOut" value="${outISO}" required />
              <button class="booking-btn primary" type="submit">Save changes</button>
            </form>
          ` : `<div class="muted-note">Actions unavailable for ${status} booking</div>`}
        </div>
      `;
    }).join("");

    el.querySelectorAll(".js-edit").forEach((btn) => {
      btn.addEventListener("click", () => {
        const id = btn.dataset.id;
        const form = el.querySelector(`.js-edit-form[data-id="${id}"]`);
        if (!form) return;
        form.style.display = form.style.display === "none" || !form.style.display ? "flex" : "none";
      });
    });

    el.querySelectorAll(".js-cancel").forEach((btn) => {
      btn.addEventListener("click", async () => {
        const id = btn.dataset.id;
        if (!confirm("Cancel this booking?")) return;

        try {
          await api(`/api/bookings/my/${id}`, { method: "DELETE" });
          location.reload();
        } catch (e) {
          showToast(e.message || "Failed to cancel booking");
        }
      });
    });

    el.querySelectorAll(".js-edit-form").forEach((form) => {
      form.addEventListener("submit", async (ev) => {
        ev.preventDefault();
        const id = form.dataset.id;
        const fd = new FormData(form);

        try {
          await api(`/api/bookings/my/${id}`, {
            method: "PUT",
            body: {
              checkIn: fd.get("checkIn"),
              checkOut: fd.get("checkOut")
            }
          });
          location.reload();
        } catch (e) {
          showToast(e.message || "Failed to update booking");
        }
      });
    });
  } catch (err) {
    console.error(err);
    document.getElementById("error").innerHTML =
      "<div class='alert'>" + (err.message || "Error loading bookings") + "</div>";
  }
})();
</script>

</body>
</html>
